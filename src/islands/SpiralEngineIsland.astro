---
import { RENDERER } from '../config/graphics';
import { getCollection } from 'astro:content';
import TileCard from '../components/TileCard.astro';
import type { TileSpec } from '../utils/tiles/types';

// Load sections from content collection
const sections = await getCollection('sections');

// Map sections to tile specifications
const tiles: TileSpec[] = sections
  .filter((s) => s.data.bbox) // Only sections with bounding boxes
  .map((s, i) => ({
    id: s.slug,
    title: s.data.title,
    route: `/sections/${s.slug}`,
    summary: s.data.description,
    bbox: s.data.bbox!,
    priority: s.data.priority ?? (sections.length - i),
  }))
  .sort((a, b) => (b.priority ?? 0) - (a.priority ?? 0));
---

<div id="spiral-container" class="relative w-full h-full">
  <!-- Canvas will be mounted here -->
  <div id="spiral-canvas" class="absolute inset-0"></div>

  <!-- Tile overlays (positioned by script) -->
  <div id="tile-container" class="absolute inset-0 pointer-events-none">
    {tiles.map((tile) => (
      <TileCard 
        tile={tile} 
        x={0} 
        y={0} 
        scale={0.8} 
        focused={false} 
        visible={false}
      />
    ))}
  </div>

  <!-- Instructions overlay -->
  <div class="absolute top-4 left-4 z-20 bg-spiral-dark/80 backdrop-blur-sm rounded-lg p-4 text-sm text-gray-400 max-w-xs">
    <h4 class="text-spiral-light font-semibold mb-2">Navigation</h4>
    <ul class="space-y-1">
      <li>üñ±Ô∏è Scroll to zoom in/out</li>
      <li>üì± Pinch to zoom</li>
      <li>‚å®Ô∏è +/- to zoom</li>
      <li>‚å®Ô∏è Space to open menu</li>
    </ul>
  </div>

  <!-- Debug toggle -->
  <button
    id="debug-toggle"
    class="absolute bottom-4 right-4 z-20 px-3 py-2 bg-spiral-dark/80 backdrop-blur-sm rounded text-xs text-gray-400 hover:text-spiral-light transition-colors"
    aria-label="Toggle debug info"
  >
    Debug: OFF
  </button>
</div>

<script type="application/json" id="spiral-data">
{JSON.stringify({ tiles, rendererMode: RENDERER })}
</script>

<script type="module">
  import { initSpiral } from './spiralClient.ts';
  const dataEl = document.getElementById('spiral-data');
  const data = dataEl ? JSON.parse(dataEl.textContent || '{}') : {};
  initSpiral(data);
</script>

